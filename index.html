<!DOCTYPE html>
<head>
    <style>
        body, html {
            padding: 0;
            margin: 0;
            height: 100%;
            background-color: hsla(0, 0%, 0%, 1);
        }

        canvas {
            z-index: -1;
        }

        p {
            color: white;
            background-color: black;
        }

        #controls {
            background-color: hsla(0, 0%, 0%, 0.5);
            color: hsl(0, 0%, 90%);
            position: absolute;
            padding: 5px;
        }

        button {
            height: 30px;
        }

        button, input {
            display: block;
        }

    </style>
    <title id="title"></title>
</head>

<body>
<div id="container">
    <div id="controls">
        <button onclick="document.getElementById('inputUploadImage').click()">Load image</button>
        <input type="file" style="display:none" id="inputUploadImage" name="inputUploadImage" accept="image/*">
        <br>
        <button onclick="pixelSort()">Sort</button>
        <br>
        <label id="fps" style="horiz-align: right;"></label>
    </div>

    <canvas id="canvas"></canvas>
</div>
<script type="text/javascript" src="https://livejs.com/live.js"></script>
<script type="text/javascript" src="../../../utils/utils.js"></script>
<script type="application/javascript">
    let canvas = document.getElementById("canvas");
    let c = canvas.getContext("2d");
    let width, height;
    let image, tempImage;
    image = new Image();
    tempImage = new Image();

    function update(time) {
        document.getElementById("fps").innerHTML = averageFps();
        time *= 0.01;
        animate(time);
        requestAnimationFrame(update);
    }

    function animate(time) {
        pixelSort();
    }

    window.onload = function () {
        let input = document.getElementById('inputUploadImage');
        input.addEventListener('change', handleFiles, false);
        requestAnimationFrame(update);
    }

    function handleFiles(e) {
        let reader = new FileReader();
        let file = e.target.files[0];
        // load to image to get it's width/height

        image.onload = function () {
            canvas.width = image.width;
            canvas.height = image.height;
            c.drawImage(image, 0, 0);
        }
        // this is to setup loading the image
        reader.onloadend = function () {
            image.src = reader.result;
        }
        // this is to read the file
        reader.readAsDataURL(file);
    }

    function pixelSort() {
        console.log("henlo");
        let imageData = c.getImageData(0, 0, canvas.width, canvas.height);
        let imageDataTemp = c.getImageData(0, 0, canvas.width, canvas.height);
        let pixelSource = imageData.data;
        let pixelTemp = imageDataTemp.data;
        for (let y = 0; y < canvas.height; y++) {
            let row = [];
            for (let x = 0; x < canvas.width; x++) {
                row.push(getPixel(pixelSource, x, y));
            }
            row.sort((pixelA, pixelB) => {
                if(Math.random() > 0.1) {
                    return 0;
                }
                let sumA = pixelA[0] + pixelA[1] + pixelA[2];
                let sumB = pixelB[0] + pixelB[1] + pixelB[2];
                if(sumA > sumB) {
                    return 1;
                }
                if(sumA < sumB) {
                    return -1;
                }
                return 0;
            });
            for (let x = 0; x < canvas.width; x++) {
                setPixel(pixelTemp, x, y, row[x]);
            }
        }
        c.putImageData(imageDataTemp, 0, 0);
    }

    function comparePixels(pixelA, pixelB) {
        let sumA = pixelA[0] + pixelA[1] + pixelA[2];
        let sumB = pixelB[0] + pixelB[1] + pixelB[2];
        if(sumA > sumB) {
            return 1;
        }
        if(sumA < sumB) {
            return -1;
        }
        return 0;
    }

    function getPixel(pixels, x, y) {
        let i = (x + y * canvas.width) * 4;
        return [pixels[i], pixels[i + 1], pixels[i + 2], pixels[i + 3]];
    }

    function setPixel(pixels, x, y, rgba) {
        let i = (x + y * canvas.width) * 4;
        pixels[i] = rgba[0];
        pixels[i + 1] = rgba[1];
        pixels[i + 2] = rgba[2];
        pixels[i + 3] = rgba[3];
    }
</script>
</body>
